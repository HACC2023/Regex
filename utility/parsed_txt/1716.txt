Question: Virtual Server: How to install and configure backups (Bacula Enterprise) on a Windows Server
Article Text: SUMMARY: The Bacula backup service is the optional daily backup service listed in the ITS VMware Hosted Solutions page. Backups are FILE LEVEL only. If you are a VM customer and have purchased this service, a client will need to be configured on your server to communicate with the backup server. This article describes installing and configuring the Bacula client on a Windows Server VM. PREREQUISITES You should already have this service purchased through ITS Managed Services. A staff member will provide information to the private network for the backups: Private network IP address Private network gateway address Private network subnet mask An additional network interface (NIC) for the private network will also be added on the VM and an installation file for the Bacula Enterprise client will be sent to you (via UH Filedrop). PLEASE NOTE: Some virtual servers were not configured to have two networks. If your server has only one network, please follow these instructions. DETAILS: Part I: Configuring the private network and adding static routes Part II: Configuring the backup client Part I: Configuring the private network and adding static routes Confirm that you have a secondary network interface added on your VM. This can be viewed in the Network Connections window, or by going to Start > Control Panel > Network and Sharing Center > Change adapter settings. To easily differentiate between the two interfaces, you can rename your primary interface to something like "Public" and "Backup-private" for the secondary interface. The public network interface has the public facing IP configured for the VM. Right-click on the secondary (private) interface and go to Properties. Uncheck "Internet Protocal Version 6 (TCP/IPv6)" and select "Internet Protocol Version 4 (TCP/IPv4)" and click Properties. Select "Use the following IP address" in the window that opens and fill out the network information. Below is an example of what the configuration will look like. The IP address in the screenshot is just an example; your actual private IP address will be provided by staff. IP address: provided by ITS staff Subnet mask: provided by ITS staff Default gateway: left BLANK Preferred DNS server: 192.168.10.115 Alternate DNS server: 192.168.10.116 Click OK to confirm the settings and save. Next, static routes will need to be configured on the private network interface. Open the Command Prompt and run as an admistrator and enter netstat -r to display the routing table (the window will need to be expanded to show the entire output). Take note of the Interface List in the output as you will need to note down the interface number. In this example, the interface number of the secondard private interface is "16" (outlined in red below). You should also double-check the MAC address to make sure it is correct. Run the following commands in the terminal to add the static routes. You will need to know your private gateway IP address as provided by Managed Services staff. route add 10.0.0.0 mask 255.0.0.0 <gateway IP> -p IF <interface number> route add 172.16.0.0 mask 255.240.0.0 <gateway IP> -p IF <interface number> route add 192.168.0.0 mask 255.255.0.0 <gateway IP> -p IF <interface number> The screenshot example shows adding the three static routes to the private gateway IP address 172.17.36.1 to the secondary network interface, which Windows defined as 16. Enter netstat -r again in the command prompt to confirm the addition of the static routes. To test that the routes are properly configured, run the nslookup command on these two hosts to verify it resolves to those IPs. This ensures that the server is able to see the two Bacula backup servers. dr-dir12.pvt.hawaii.edu 172.24.100.11 dr-sto12.pvt.hawaii.edu 172.24.100.12 NOTE: On Windows Server 2016, the nslookup command may not properly resolve the Bacula hosts unless you specify the private DNS server, i.e. nslookup dr-dir12.pvt.hawaii.edu 192.168.10.115 Update the Windows Firewall to allow incoming traffic on ports 9102 and 9103 from dr-dir12.pvt.hawaii.edu (172.24.100.11) and dr-sto12.pvt.hawaii.edu (172.24.100.12). Reference on configuring Windows Firewall: https://www.rootusers.com/configure-windows-firewall-advanced-security/ Single-Network Servers Your virtual server may not have been configured with two networks. If you have a single public network assigned on your server, you do not need to setup static routing. Please be sure to change the DNS addresses on the public network interface to the following: 192.168.10.115 192.168.10.116 Then, run nslookup dr-dir12.pvt.hawaii.edu 192.168.10.115 to verify that the Bacula server host can be resolved. After that, you may follow the instructions to install the Bacula client. Part II: Configuring the backup client Install the Bacula Enterprise 8.6.16 client (bacula-enterprise-win64-8.6.16.exe) by right-clicking the file and selecting “Run as Administrator”. Click Next at the below dialog box. If you agree to the license agreement, click I Agree at the below dialog box. Choose Automatic at the below dialog box and then click Next. When the dialog box below appears, select the items below and uncheck the others. Client Plugins - Place a checkmark next to “alldrives Plugin” - Place a checkmark next to “winbmr Plugin” - Uncheck “Old (deprecated) Exchange Plugin” Enter the following value into the DIR Name field. DIR Name: bacula-dir Leave the “Save Client template in” checkbox UNCHECKED. Click Finish at the below dialog box. It’s probably a good idea to read the Readme file. Open Notepad as an Administrator (right-click it and go to "Run as Administrator). Open C:\Programs Files\Bacula\bacula-fd.conf. In the below section, remove the “-fd” from the shortname of the host (for example, hostname-fd to hostname). Also, change Maximum Concurrent Jobs to 20. FileDaemon { # this is me Name = hostname FDport = 9102 # where we listen for the director WorkingDirectory = "C:\\Program Files\\Bacula\\working" Pid Directory = "C:\\Program Files\\Bacula\\working" Plugin Directory = "C:\\Program Files\\Bacula\\plugins" Maximum Concurrent Jobs = 20 } DELETE the below section: # # Restricted Director, used by tray-monitor to get the # status of the file daemon # Director { Name = hostname-mon Password ="some-password" Monitor = yes } In the "some-password" field, copy this password and save it in a separate text file. You will need to file drop this to us so that it can be configured on our end. # # List Directors who are permitted to contact this File daemon # Director { Name = bacula-dir Password = "some-password" # Director must know this password } Save your changes to the bacula-fd.conf file and close it. You may want to re-open it again just to ensure changed have been saved. Go to Administrative Tools > Services and restart the Bacula File Backup Service. Search for Bacula File Backup Service right click, and select Restart. The process should start with no errors. If you get an error or if the process hangs, review the previous steps to ensure Bacula was installed and configured correctly. The Bacula installation and setup process is now complete. Email itscs@hawaii.edu to let us know that the client has been configured. A staff member will respond and ask you to send the password (via UH Filedrop) that you saved earlier so we can start the backups. RELATED ARTICLES: Data Center Services Virtual Hosting: How to Submit a Restore Request Virtual Server: File Level Backup Policy Virtual Server: How to install and configure backups (Bacula) on a Red Hat Linux Server
